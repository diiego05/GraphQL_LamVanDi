<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${user.id == null ? 'Th√™m M·ªõi Ng∆∞·ªùi d√πng' : 'Ch·ªânh S·ª≠a Ng∆∞·ªùi d√πng'}"></title>
</head>
<body th:replace="~{layouts/admin-layout :: layout(
    pageTitle=${user.id == null ? 'Th√™m M·ªõi Ng∆∞·ªùi d√πng' : 'Ch·ªânh S·ª≠a Ng∆∞·ªùi d√πng'},
    pageContent=~{::pageContent},
    additionalJs=~{::additionalJs}
)}">

<div class="page-content" th:fragment="pageContent">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0" th:text="${user.id == null ? 'Th√™m M·ªõi Ng∆∞·ªùi d√πng' : 'Ch·ªânh S·ª≠a Ng∆∞·ªùi d√πng'}"></h5>
        </div>
        <div class="card-body">

            <!-- ‚úÖ Form ch√≠nh -->
            <form th:action="@{/admin/users/save}" th:object="${user}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:field="*{id}" />

                <!-- üìå Hi·ªÉn th·ªã t·∫•t c·∫£ l·ªói ·ªü ƒë·∫ßu form -->
                <div th:if="${#fields.hasAnyErrors()}" class="alert alert-danger mb-3">
                    <ul class="mb-0">
                        <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                    </ul>
                </div>

                <div class="row">
                    <!-- üßë ·∫¢nh ƒë·∫°i di·ªán -->
                    <div class="col-12 mb-3">
                        <label class="form-label">·∫¢nh ƒë·∫°i di·ªán</label><br>
                        <img th:src="${user.avatarUrl != null} ? @{${user.avatarUrl}} : @{/images/avatar-default.jpg}"
                             alt="Avatar" class="img-thumbnail mb-2"
                             style="width: 100px; height: 100px;">
                        <input type="file" name="avatarFile" class="form-control">
                    </div>

                    <!-- üë§ H·ªç t√™n -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">H·ªç t√™n</label>
                        <input type="text" class="form-control"
                               th:field="*{fullName}"
                               th:classappend="${#fields.hasErrors('fullName')} ? 'is-invalid' : ''" />
                        <div class="invalid-feedback" th:errors="*{fullName}"></div>
                    </div>

                    <!-- üìß Email -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control"
                               th:field="*{email}"
                               th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''" />
                        <div class="invalid-feedback" th:errors="*{email}"></div>
                    </div>

                    <!-- üì± SƒêT -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" class="form-control"
                               th:field="*{phone}"
                               th:classappend="${#fields.hasErrors('phone')} ? 'is-invalid' : ''" />
                        <div class="invalid-feedback" th:errors="*{phone}"></div>
                    </div>

                    <!-- üîê M·∫≠t kh·∫©u -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control"
                               th:field="*{rawPassword}"
                               th:placeholder="${user.id != null ? 'ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi' : ''}"
                               th:classappend="${#fields.hasErrors('rawPassword')} ? 'is-invalid' : ''" />
                        <div class="invalid-feedback" th:errors="*{rawPassword}"></div>
                    </div>

                    <!-- ü™™ CCCD -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">S·ªë CCCD</label>
                        <input type="text" class="form-control"
                               th:field="*{idCardNumber}"
                               th:classappend="${#fields.hasErrors('idCardNumber')} ? 'is-invalid' : ''" />
                        <div class="invalid-feedback" th:errors="*{idCardNumber}"></div>
                    </div>

                    <!-- üéÇ Ng√†y sinh -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ng√†y sinh</label>
                        <input type="date" class="form-control"
                               th:field="*{dateOfBirth}"
                               th:classappend="${#fields.hasErrors('dateOfBirth')} ? 'is-invalid' : ''" />
                        <div class="invalid-feedback" th:errors="*{dateOfBirth}"></div>
                    </div>

                    <!-- üöª Gi·ªõi t√≠nh -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Gi·ªõi t√≠nh</label>
                        <select class="form-select" th:field="*{gender}"
                                th:classappend="${#fields.hasErrors('gender')} ? 'is-invalid' : ''">
                            <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                            <option value="Kh√°c">Kh√°c</option>
                        </select>
                        <div class="invalid-feedback" th:errors="*{gender}"></div>
                    </div>

                    <!-- üßë Vai tr√≤ -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Vai tr√≤</label>
                        <select class="form-select" th:field="*{role}" id="roleSelect"
                                th:classappend="${#fields.hasErrors('role')} ? 'is-invalid' : ''">
                            <option th:each="role : ${roleList}"
                                    th:value="${role.id}"
                                    th:text="${role.name}"
                                    th:attr="data-code=${role.code}"></option>
                        </select>
                        <div class="invalid-feedback" th:errors="*{role}"></div>
                    </div>

                    <!-- üü° Tr·∫°ng th√°i -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-select" th:field="*{status}"
                                th:classappend="${#fields.hasErrors('status')} ? 'is-invalid' : ''">
                            <option value="ACTIVE">Ho·∫°t ƒë·ªông</option>
                            <option value="BANNED">B·ªã c·∫•m</option>
                            <option value="INACTIVE">Ng·ª´ng ho·∫°t ƒë·ªông</option>
                        </select>
                        <div class="invalid-feedback" th:errors="*{status}"></div>
                    </div>
                </div>

                <!-- üè† ƒê·ªãa ch·ªâ kh√°ch h√†ng -->
                <div id="address-section" style="display: none;">
                    <hr>
                    <h5>ƒê·ªãa ch·ªâ m·∫∑c ƒë·ªãnh c·ªßa kh√°ch h√†ng</h5>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                            <input type="text" class="form-control" name="addressLine1"
                                   th:value="${defaultAddress != null ? defaultAddress.line1 : ''}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                            <input type="text" class="form-control" name="addressCity"
                                   th:value="${defaultAddress != null ? defaultAddress.city : ''}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ph∆∞·ªùng / X√£</label>
                            <input type="text" class="form-control" name="addressWard"
                                   th:value="${defaultAddress != null ? defaultAddress.ward : ''}">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">L∆∞u l·∫°i</button>
                <a th:href="@{/admin/users}" class="btn btn-secondary mt-3">H·ªßy</a>
            </form>
        </div>
    </div>
</div>

<!-- ‚úÖ JS toggle ƒë·ªãa ch·ªâ -->
<th:block th:fragment="additionalJs">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('roleSelect');
            const addressSection = document.getElementById('address-section');

            function toggleAddressSection() {
                const selectedOption = roleSelect.options[roleSelect.selectedIndex];
                const roleCode = selectedOption ? selectedOption.getAttribute('data-code') : null;
                addressSection.style.display = (roleCode === 'USER') ? 'block' : 'none';
            }

            toggleAddressSection();
            roleSelect.addEventListener('change', toggleAddressSection);
        });
    </script>
</th:block>
</body>
</html>
