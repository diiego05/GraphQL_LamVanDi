<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/admin-layout :: layout(
                    pageTitle='Nh√† v·∫≠n chuy·ªÉn',
                    pageContent=~{::pageContent},
                    additionalJs=~{::additionalJs}
                  )}">

<!-- N·ªòI DUNG TRANG -->
<th:block th:fragment="pageContent">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">üöö Qu·∫£n l√Ω Nh√† V·∫≠n Chuy·ªÉn</h3>
        <button class="btn btn-primary" id="btn-add">
            <i class="fas fa-plus me-2"></i> Th√™m m·ªõi
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-success">
                        <tr>
                            <th>T√™n</th>
                            <th>Logo</th>
                            <th>Ph√≠ c∆° b·∫£n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th class="text-center" style="width: 220px;">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="carrier-table-body">
                        <tr>
                            <td colspan="5" class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal th√™m/s·ª≠a -->
    <div class="modal fade" id="carrierModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Th√™m / S·ª≠a Nh√† V·∫≠n Chuy·ªÉn</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="carrier-id">

            <div class="mb-3">
                <label for="carrier-name" class="form-label fw-semibold">T√™n</label>
                <input type="text" id="carrier-name" class="form-control" placeholder="T√™n nh√† v·∫≠n chuy·ªÉn" required>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Logo</label>
                <input type="file" id="carrier-logo-file" class="form-control" accept="image/*">
                <div class="mt-3 d-flex justify-content-center">
                    <img id="carrier-logo-preview"
                         src="/images/no-logo.png"
                         alt="Preview"
                         class="img-thumbnail"
                         style="width:250px; height:150px; object-fit:contain;">
                </div>
            </div>

            <div class="mb-3">
                <label for="carrier-fee" class="form-label fw-semibold">Ph√≠ c∆° b·∫£n (‚Ç´)</label>
                <input type="number" id="carrier-fee" class="form-control" placeholder="0" min="0" required>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button class="btn btn-success" id="btn-save">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>

</th:block>

<!-- JS RI√äNG CHO TRANG -->
<th:block th:fragment="additionalJs">
<script type="module">
// üß≠ L·∫•y context path ƒë·ªÉ import JS (ch·ªâ d√πng cho import, kh√¥ng d√πng ƒë·ªÉ g·ªçi API)
const contextPath = '/' + window.location.pathname.split('/')[1];
const jsPath = contextPath === '/' ? '/js/auth-helper.js' : `${contextPath}/js/auth-helper.js`;
const { apiFetch } = await import(jsPath);

// Bi·∫øn DOM
const tableBody = document.getElementById("carrier-table-body");
const modalEl = new bootstrap.Modal(document.getElementById('carrierModal'));
const nameInput = document.getElementById("carrier-name");
const feeInput = document.getElementById("carrier-fee");
const idInput = document.getElementById("carrier-id");
const logoFileInput = document.getElementById("carrier-logo-file");
const logoPreview = document.getElementById("carrier-logo-preview");

let currentLogoUrl = "";

// üü¢ Load danh s√°ch
async function loadCarriers() {
    const res = await apiFetch(`/api/admin/shipping-carriers`);
    if (!res.ok) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>`;
        return;
    }

    const data = await res.json();
    if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ nh√† v·∫≠n chuy·ªÉn n√†o</td></tr>`;
        return;
    }

    tableBody.innerHTML = data.map(c => `
        <tr>
            <td>${c.name}</td>
            <td>
                <img src="${c.logoUrl || '/images/no-logo.png'}"
                     class="img-thumbnail"
                     style="width:180px; height:100px; object-fit:contain;">
            </td>
            <td>${Number(c.baseFee).toLocaleString('vi-VN')} ‚Ç´</td>
            <td><span class="badge ${c.active ? 'bg-success' : 'bg-secondary'}">${c.active ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-info me-1" onclick="editCarrier(${c.id}, '${c.name}', '${c.logoUrl || ''}', ${c.baseFee})"><i class="fas fa-pen"></i></button>
                <button class="btn btn-sm btn-warning me-1" onclick="toggleStatus(${c.id})"><i class="fas fa-toggle-on"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteCarrier(${c.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

// ‚ûï Th√™m m·ªõi
document.getElementById("btn-add").addEventListener("click", () => {
    idInput.value = "";
    nameInput.value = "";
    feeInput.value = "";
    logoFileInput.value = "";
    logoPreview.src = "/images/no-logo.png";
    currentLogoUrl = "";
    modalEl.show();
});

// üíæ L∆∞u (th√™m ho·∫∑c s·ª≠a)
document.getElementById("btn-save").addEventListener("click", async () => {
    let logoUrl = currentLogoUrl;
    const file = logoFileInput.files[0];

    // üì§ N·∫øu c√≥ ch·ªçn file => upload l√™n Cloudinary
    if (file) {
        const formData = new FormData();
        formData.append("file", file);

        const uploadRes = await fetch(`${contextPath}/api/upload/logo`, {
            method: "POST",
            body: formData
        });

        if (!uploadRes.ok) {
            alert("‚ùå L·ªói upload ·∫£nh");
            return;
        }

        const uploadData = await uploadRes.json();
        logoUrl = uploadData.url;
    }

    const payload = {
        name: nameInput.value.trim(),
        logoUrl: logoUrl,
        baseFee: Number(feeInput.value),
        active: true
    };

    const id = idInput.value;
    const method = id ? "PUT" : "POST";
    const url = id ? `/api/admin/shipping-carriers/${id}` : `/api/admin/shipping-carriers`;

    const res = await apiFetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        modalEl.hide();
        loadCarriers();
    } else {
        alert("‚ùå L·ªói khi l∆∞u nh√† v·∫≠n chuy·ªÉn");
    }
});

// ‚úèÔ∏è Edit
window.editCarrier = (id, name, logo, fee) => {
    idInput.value = id;
    nameInput.value = name;
    feeInput.value = fee;
    logoPreview.src = logo || '/images/no-logo.png';
    currentLogoUrl = logo;
    logoFileInput.value = "";
    modalEl.show();
};

// üîÅ B·∫≠t / T·∫Øt tr·∫°ng th√°i
window.toggleStatus = async (id) => {
    await apiFetch(`/api/admin/shipping-carriers/${id}/toggle`, { method: "PUT" });
    loadCarriers();
};

// üóëÔ∏è X√≥a
window.deleteCarrier = async (id) => {
    if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√† v·∫≠n chuy·ªÉn n√†y?")) {
        await apiFetch(`/api/admin/shipping-carriers/${id}`, { method: "DELETE" });
        loadCarriers();
    }
};

// üñºÔ∏è Preview ·∫£nh khi ch·ªçn file
logoFileInput.addEventListener("change", () => {
    const file = logoFileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = e => logoPreview.src = e.target.result;
        reader.readAsDataURL(file);
    }
});

// üöÄ Kh·ªüi ƒë·ªông
loadCarriers();
</script>
</th:block>

</html>
