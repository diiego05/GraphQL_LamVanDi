<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/default_layout :: body(content=~{::content}, additionalJs=~{::additionalJs})}">
<head>
    <th:block th:fragment="additionalCss"></th:block>
    <style>
        .product-card .badge {
            font-size: 0.85rem;
        }
        .product-card .card-img-top {
            transition: transform 0.3s ease;
        }
        .product-card:hover .card-img-top {
            transform: scale(1.05);
        }
        .cart-toast {
            position: fixed;
            right: 120px;
            bottom: 110px;
            background: #198754;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
            pointer-events: none;
            z-index: 9999;
        }
        .cart-toast.show { opacity: 1; transform: translateY(0); }
        @keyframes bounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.25); }
            60% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .bounce { animation: bounce 0.4s ease; }
    </style>
</head>

<body>
<th:block th:fragment="content">

    <!-- Hero -->
    <section class="hero-section text-center d-flex align-items-center justify-content-center">
        <div class="container"></div>
    </section>

    <!-- üèÜ S·∫¢N PH·∫®M B√ÅN CH·∫†Y -->
    <section class="container my-5" id="best-sellers">
        <h2 class="section-title">S·∫¢N PH·∫®M B√ÅN CH·∫†Y</h2>

        <div id="product-list-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-4">
            <div class="col" th:each="product : ${bestSellers}">
                <div class="card product-card h-100 shadow-sm border-0">
                    <a th:href="@{/product/{id}(id=${product.id})}">
                        <img th:src="@{${product.imageUrl != null ? product.imageUrl : '/images/placeholder.png'}}"
                             class="card-img-top rounded-top"
                             th:alt="${product.name}" />
                    </a>

                    <div class="card-body d-flex flex-column text-center">
                        <h5 class="card-title mb-3">
                            <a th:href="@{/product/{id}(id=${product.id})}"
                               class="text-decoration-none text-dark fw-semibold"
                               th:text="${product.name}">T√™n s·∫£n ph·∫©m</a>
                        </h5>

                        <p class="price mt-auto text-success fw-bold fs-5"
                           th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                            Gi√° s·∫£n ph·∫©m
                        </p>

                        <a href="#" class="btn btn-success btn-add-to-cart mt-2"
                           th:data-product-id="${product.id}">
                            <i class="fas fa-shopping-cart me-1"></i> ƒê·∫∑t mua
                        </a>
                    </div>
                </div>
            </div>

            <div th:if="${#lists.isEmpty(bestSellers)}" class="col-12 text-center">
                <p>Ch∆∞a c√≥ s·∫£n ph·∫©m b√°n ch·∫°y n√†o.</p>
            </div>
        </div>

        <!-- N√∫t xem th√™m -->
        <div class="text-center mt-5" th:if="${#lists.size(bestSellers) > 5}">
            <th:block th:with="hiddenProductCount=${#lists.size(bestSellers) - 5}">
                <button id="view-more-btn" class="btn btn-outline-success btn-lg"
                        th:text="'Xem th√™m ' + ${hiddenProductCount} + ' s·∫£n ph·∫©m'"></button>
            </th:block>
        </div>
    </section>

    <!-- üî• S·∫¢N PH·∫®M GI·∫¢M GI√Å -->
    <section class="container my-5" id="discount-products">
        <h2 class="section-title ">S·∫¢N PH·∫®M GI·∫¢M GI√Å</h2>

        <div id="discount-product-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-4">
            <!-- Render b·∫±ng JS -->
        </div>

        <div class="text-center mt-5" id="discount-view-more-container" style="display:none;">
            <button id="discount-view-more-btn" class="btn btn-outline-success btn-lg"></button>
        </div>
    </section>

    <!-- üì¢ GI·ªöI THI·ªÜU -->
    <section class="container my-5 py-5 bg-light rounded shadow-sm text-center">
        <h2 class="section-title">V·ªÅ AloTra</h2>
        <p class="lead w-75 mx-auto">
            AloTra mang ƒë·∫øn nh·ªØng ly tr√† s·ªØa ch·∫•t l∆∞·ª£ng, pha ch·∫ø t·ª´ nguy√™n li·ªáu t∆∞∆°i ngon ch·ªçn l·ªçc.
            Ch√∫ng t√¥i tin r·∫±ng m·ªói ly tr√† s·ªØa kh√¥ng ch·ªâ l√† th·ª©c u·ªëng, m√† c√≤n l√† ni·ªÅm vui, l√† kho·∫£nh kh·∫Øc th∆∞ gi√£n tuy·ªát v·ªùi c·ªßa b·∫°n.
        </p>
        <a th:href="@{/about}" class="btn btn-outline-success btn-lg mt-4">T√¨m hi·ªÉu th√™m</a>
    </section>

</th:block>

<!-- =================== SCRIPT =================== -->
<th:block th:fragment="additionalJs">
<script>
$(document).ready(function () {
    console.log("‚úÖ Trang ch·ªß ƒë√£ s·∫µn s√†ng.");

    // ================= üèÜ Ph·∫ßn b√°n ch·∫°y =================
    const productContainer = $("#product-list-container");
    const viewMoreBtn = $("#view-more-btn");

    if (productContainer.length && viewMoreBtn.length) {
        const hiddenProducts = productContainer.find(".col:gt(4)").hide();
        if (hiddenProducts.length === 0) viewMoreBtn.hide();
        viewMoreBtn.on('click', function () {
            hiddenProducts.show();
            $(this).hide();
        });
    }

    // ================= üî• Ph·∫ßn s·∫£n ph·∫©m gi·∫£m gi√° =================
    $.get("/alotra-website/api/products/public/top-discount", function (products) {
        const container = $("#discount-product-list");
        const viewMoreContainer = $("#discount-view-more-container");
        const viewMoreBtn = $("#discount-view-more-btn");

        if (!products || products.length === 0) {
            container.html(`<div class="col-12 text-center"><p>Ch∆∞a c√≥ s·∫£n ph·∫©m gi·∫£m gi√°.</p></div>`);
            return;
        }

        products.forEach((p, index) => {
            const originalPrice = p.originalPrice ? new Intl.NumberFormat('vi-VN').format(p.originalPrice) + " ‚Ç´" : "";
            const discountedPrice = p.discountedPrice ? new Intl.NumberFormat('vi-VN').format(p.discountedPrice) + " ‚Ç´" : "";

            const tagSale = p.hasDiscount ? `
                <div class="badge bg-danger position-absolute top-0 end-0 m-2 px-2 py-1 rounded-pill">
                    SALE -${p.discountPercent}%
                </div>` : ``;

            const priceHtml = p.hasDiscount ? `
                <div class="mb-3">
                    <span class="text-muted text-decoration-line-through me-2">${originalPrice}</span>
                    <span class="text-success fw-bold fs-5">${discountedPrice}</span>
                </div>` :
                `<div class="mb-3">
                    <span class="text-success fw-bold fs-5">${originalPrice}</span>
                </div>`;

            const card = `
                <div class="col discount-col" ${index >= 5 ? 'style="display:none;"' : ''}>
                    <div class="card product-card h-100 shadow-sm border-0 position-relative">
                        ${tagSale}
                        <a href="/alotra-website/product/${p.id}">
                            <img src="${p.imageUrl || '/alotra-website/images/placeholder.png'}"
                                 class="card-img-top rounded-top" alt="${p.name}">
                        </a>
                        <div class="card-body d-flex flex-column text-center">
                            <h5 class="card-title mb-2">
                                <a href="/alotra-website/product/${p.id}"
                                   class="text-decoration-none text-dark fw-semibold">${p.name}</a>
                            </h5>
                            ${priceHtml}
                            <a href="#" class="btn btn-success btn-add-to-cart mt-auto"
                               data-product-id="${p.id}">
                               <i class="fas fa-shopping-cart me-1"></i> ƒê·∫∑t mua
                            </a>
                        </div>
                    </div>
                </div>
            `;
            container.append(card);
        });

        if (products.length > 5) {
            const hiddenCount = products.length - 5;
            viewMoreBtn.text(`Xem th√™m ${hiddenCount} s·∫£n ph·∫©m`);
            viewMoreContainer.show();
            viewMoreBtn.on("click", function () {
                $(".discount-col").show();
                $(this).hide();
            });
        }
    });

    // ================= üõí Th√™m v√†o gi·ªè h√†ng =================
    $(document).on("click", ".btn-add-to-cart", function (e) {
        e.preventDefault();
        const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
        if (!token) {
            showCartToast("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.", true);
            return;
        }

        const productId = $(this).data("product-id");
        if (!productId) {
            showCartToast("‚ùå Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m.", true);
            return;
        }

        $.ajax({
            url: "/alotra-website/api/cart/items",
            type: "POST",
            contentType: "application/json",
            headers: { "Authorization": "Bearer " + token },
            data: JSON.stringify({ productId: productId, quantity: 1 }),
            success: function () {
                showCartToast("‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!");
                bounceCartIcon();
                updateCartFloatingCount();
            }
        });
    });

    // ================= üõí Khi nh·∫•n icon gi·ªè h√†ng =================
    $(document).on("click", "#floating-cart .cart-btn", function (e) {
        const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
        if (!token) {
            e.preventDefault();
            showCartToast("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng.", true);
        }
    });

    // ================= üîî Toast th√¥ng b√°o =================
    function showCartToast(message, isError = false) {
        const toast = $("#cart-toast");
        toast.text(message);
        toast.css("background", isError ? "#dc3545" : "#198754");
        toast.addClass("show");
        clearTimeout(toast.data("timeout"));
        const timeout = setTimeout(() => toast.removeClass("show"), 2000);
        toast.data("timeout", timeout);
    }

    // ================= üõí Hi·ªáu ·ª©ng icon gi·ªè =================
    function bounceCartIcon() {
        const cartBtn = $("#floating-cart .cart-btn");
        cartBtn.addClass("bounce");
        setTimeout(() => cartBtn.removeClass("bounce"), 500);
    }

    // ================= üßÆ C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng =================
    function updateCartFloatingCount() {
        $.ajax({
            url: "/alotra-website/api/cart",
            type: "GET",
            headers: { "Authorization": "Bearer " + (localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken")) },
            success: function (cart) {
                $("#cart-count").text(cart.itemsCount || 0);
            }
        });
    }

    if (localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken")) {
        updateCartFloatingCount();
    }
});
</script>
</th:block>

</body>
</html>
