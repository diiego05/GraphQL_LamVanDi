<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/default_layout :: layout(pageTitle='S·∫£n ph·∫©m', content=~{::content}, additionalJs=~{::additionalJs})}">
<head>
    <style>
        .product-card .badge {
            font-size: 0.85rem;
        }
        .product-card .card-img-top {
            transition: transform 0.3s ease;
        }
        .product-card:hover .card-img-top {
            transform: scale(1.05);
        }
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .cart-toast {
            position: fixed;
            right: 120px;
            bottom: 110px;
            background: #198754;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
            pointer-events: none;
            z-index: 9999;
        }
        .cart-toast.show { opacity: 1; transform: translateY(0); }
        @keyframes bounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.25); }
            60% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .bounce { animation: bounce 0.4s ease; }
    </style>
</head>

<body>
<th:block th:fragment="content">
    <div class="container my-5">
        <h2 class="text-success mb-4">
            <i class="fas fa-coffee me-2"></i>T·∫•t c·∫£ s·∫£n ph·∫©m
        </h2>

        <!-- üîç B·ªô l·ªçc -->
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">T√¨m ki·∫øm</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m...">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Danh m·ª•c</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">S·∫Øp x·∫øp theo</label>
                    <select id="sortBy" class="form-select">
                        <option value="name">T√™n A-Z</option>
                        <option value="name_desc">T√™n Z-A</option>
                        <option value="price">Gi√° th·∫•p - cao</option>
                        <option value="price_desc">Gi√° cao - th·∫•p</option>
                        <option value="newest">M·ªõi nh·∫•t</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="clearFilterBtn" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-redo me-1"></i>ƒê·∫∑t l·∫°i
                    </button>
                </div>
            </div>
        </div>

        <!-- üì¶ Danh s√°ch s·∫£n ph·∫©m -->
        <div id="product-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4  pt-4">
            <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        </div>
<nav class="mt-4">
  <ul id="productPagination" class="pagination justify-content-center"></ul>
</nav>
        <!-- Loading -->
        <div id="loading" class="text-center py-5 d-none">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="text-center py-5 d-none">
            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
            <p class="text-muted">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="cart-toast" class="cart-toast"></div>
</th:block>

<th:block th:fragment="additionalJs">
<script>
$(document).ready(function () {
    console.log("‚úÖ Trang s·∫£n ph·∫©m ƒë√£ s·∫µn s√†ng.");

    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const rowsPerPage = 8;

    // ‚úÖ ƒê·ªçc URL params ƒë·ªÉ l·ªçc theo category t·ª´ MegaMenu
    const urlParams = new URLSearchParams(window.location.search);
    const categorySlugFromUrl = urlParams.get('category');

    // ================= LOAD CATEGORIES =================
    async function loadCategories() {
        try {
            const res = await fetch("/alotra-website/api/categories/tree");
            if (!res.ok) return;
            const categories = await res.json();

            const select = $("#categoryFilter");

            // ‚úÖ H√†m ƒë·ªá quy ƒë·ªÉ th√™m categories v√† t√¨m ID t·ª´ slug
            let categoryIdFromSlug = null;

            function addCategoryOptions(catList, prefix = '') {
                catList.forEach(cat => {
                    select.append(`<option value="${cat.id}">${prefix}${cat.title}</option>`);

                    // ‚úÖ T√¨m categoryId t·ª´ URL slug
                    if (categorySlugFromUrl && cat.url && cat.url.includes(`category=${categorySlugFromUrl}`)) {
                        categoryIdFromSlug = cat.id;
                    }

                    if (cat.children && cat.children.length > 0) {
                        cat.children.forEach(child => {
                            select.append(`<option value="${child.id}">${prefix}&nbsp;&nbsp;‚îî‚îÄ ${child.title}</option>`);

                            // ‚úÖ T√¨m trong children
                            if (categorySlugFromUrl && child.url && child.url.includes(`category=${categorySlugFromUrl}`)) {
                                categoryIdFromSlug = child.id;
                            }
                        });
                    }
                });
            }

            addCategoryOptions(categories);

            // ‚úÖ T·ª± ƒë·ªông ch·ªçn category t·ª´ URL
            if (categoryIdFromSlug) {
                select.val(categoryIdFromSlug);
                console.log(`‚úÖ Auto-selected category ID ${categoryIdFromSlug} from URL`);
            }
        } catch (err) {
            console.error("‚ùå L·ªói khi t·∫£i danh m·ª•c:", err);
        }
    }

    // ================= LOAD PRODUCTS =================
    async function loadProducts() {
        $("#loading").removeClass("d-none");
        $("#product-grid").empty();
        $("#emptyState").addClass("d-none");

        try {
            const res = await fetch("/alotra-website/api/products/public");
            if (!res.ok) throw new Error("Failed to load products");

            allProducts = await res.json();
            filteredProducts = [...allProducts];
            applyFiltersAndSort();
        } catch (err) {
            console.error("‚ùå L·ªói khi t·∫£i s·∫£n ph·∫©m:", err);
            $("#loading").addClass("d-none");
            $("#emptyState").removeClass("d-none");
        }
    }

    // ================= FILTER & SORT =================
    function applyFiltersAndSort() {
        const searchTerm = $("#searchInput").val().toLowerCase().trim();
        const categoryId = $("#categoryFilter").val();
        const sortBy = $("#sortBy").val();

        // Filter
        filteredProducts = allProducts.filter(p => {
            const matchSearch = !searchTerm || p.name.toLowerCase().includes(searchTerm);
            const matchCategory = !categoryId || p.categoryId == categoryId;
            return matchSearch && matchCategory;
        });

        // Sort
        switch (sortBy) {
        case "name": filteredProducts.sort((a, b) => a.name.localeCompare(b.name)); break;
        case "name_desc": filteredProducts.sort((a, b) => b.name.localeCompare(a.name)); break;
        case "price": filteredProducts.sort((a, b) => (a.lowestPrice || 0) - (b.lowestPrice || 0)); break;
        case "price_desc": filteredProducts.sort((a, b) => (b.lowestPrice || 0) - (a.lowestPrice || 0)); break;
        case "newest": filteredProducts.sort((a, b) => b.id - a.id); break;
        }
        currentPage = 1;
        renderProducts();
        renderPagination();
    }

    // ================= RENDER PRODUCTS =================
    function renderProducts() {
        $("#loading").addClass("d-none");
        const grid = $("#product-grid");
        grid.empty();

        if (filteredProducts.length === 0) {
            $("#emptyState").removeClass("d-none");
            return;
        }

        $("#emptyState").addClass("d-none");

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredProducts.slice(start, end);

        pageData.forEach(p => {
            const originalPrice = p.originalPrice ? new Intl.NumberFormat('vi-VN').format(p.originalPrice) + " ‚Ç´" : "";
            const discountedPrice = p.discountedPrice ? new Intl.NumberFormat('vi-VN').format(p.discountedPrice) + " ‚Ç´" : "";
            const img = p.imageUrl || '/alotra-website/images/placeholder.png';

            const tagSale = p.hasDiscount ? `
                <div class="badge bg-danger position-absolute top-0 end-0 m-2 px-2 py-1 rounded-pill">
                    SALE -${p.discountPercent}%
                </div>` : ``;

            const priceHtml = p.hasDiscount
                ? `<div class="mb-2">
                    <span class="text-muted text-decoration-line-through me-2">${originalPrice}</span>
                    <span class="text-success fw-bold fs-5">${discountedPrice}</span>
                   </div>`
                : `<div class="mb-2"><span class="text-success fw-bold fs-5">${originalPrice || p.priceRange}</span></div>`;

            const card = `
                <div class="col">
                    <div class="card product-card h-100 shadow-sm border-0 position-relative">
                        ${tagSale}
                        <a href="/alotra-website/product/${p.id}">
                            <img src="${img}" class="card-img-top rounded-top" alt="${p.name}">
                        </a>
                        <div class="card-body d-flex flex-column text-center">
                            <h5 class="card-title mb-3">
                                <a href="/alotra-website/product/${p.id}"
                                   class="text-decoration-none text-dark fw-semibold">${p.name}</a>
                            </h5>
                            ${priceHtml}
                            <a href="#" class="btn btn-success btn-add-to-cart mt-auto" data-product-id="${p.id}">
                                <i class="fas fa-shopping-cart me-1"></i> ƒê·∫∑t mua
                            </a>
                        </div>
                    </div>
                </div>`;
            grid.append(card);
        });
    }
    // ================= RENDER PAGINATION =================
    function renderPagination() {
        const pagination = $("#productPagination");
        pagination.empty();

        const totalPages = Math.ceil(filteredProducts.length / rowsPerPage);
        if (totalPages <= 1) return;

        function createPageItem(label, disabled, active, onClick) {
            const li = $("<li>").addClass("page-item");
            if (disabled) li.addClass("disabled");
            if (active) li.addClass("active");
            const btn = $("<button>")
                .addClass("page-link")
                .text(label)
                .on("click", function (e) {
                    e.preventDefault();
                    if (!disabled) onClick();
                });
            li.append(btn);
            return li;
        }

        pagination.append(createPageItem("¬´", currentPage === 1, false, () => {
            currentPage--;
            renderProducts();
            renderPagination();
        }));

        const maxButtons = 5;
        let start = Math.max(1, currentPage - 2);
        let end = Math.min(totalPages, start + maxButtons - 1);
        if (end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);

        if (start > 1) {
            pagination.append(createPageItem(1, false, currentPage === 1, () => { currentPage = 1; renderProducts(); renderPagination(); }));
            if (start > 2) pagination.append(createPageItem("...", true, false, () => {}));
        }

        for (let i = start; i <= end; i++) {
            pagination.append(createPageItem(i, false, i === currentPage, () => {
                currentPage = i;
                renderProducts();
                renderPagination();
            }));
        }

        if (end < totalPages) {
            if (end < totalPages - 1) pagination.append(createPageItem("...", true, false, () => {}));
            pagination.append(createPageItem(totalPages, false, currentPage === totalPages, () => {
                currentPage = totalPages;
                renderProducts();
                renderPagination();
            }));
        }

        pagination.append(createPageItem("¬ª", currentPage === totalPages, false, () => {
            currentPage++;
            renderProducts();
            renderPagination();
        }));
    }
    // ================= EVENT HANDLERS =================
    $("#searchInput").on("input", debounce(applyFiltersAndSort, 300));
    $("#categoryFilter, #sortBy").on("change", applyFiltersAndSort);

    $("#clearFilterBtn").on("click", function() {
        $("#searchInput").val("");
        $("#categoryFilter").val("");
        $("#sortBy").val("name");
        // ‚úÖ X√≥a URL params khi clear filter
        window.history.replaceState({}, '', window.location.pathname);
        applyFiltersAndSort();
    });

    // ================= ADD TO CART =================
    $(document).on("click", ".btn-add-to-cart", function (e) {
        e.preventDefault();
        const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
        if (!token) {
            showCartToast("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.", true);
            return;
        }
        const productId = $(this).data("product-id");
        if (!productId) {
            showCartToast("‚ùå Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m.", true);
            return;
        }
        $.ajax({
            url: "/alotra-website/api/cart/items",
            type: "POST",
            contentType: "application/json",
            headers: { "Authorization": "Bearer " + token },
            data: JSON.stringify({ productId: productId, quantity: 1 }),
            success: function () {
                showCartToast("‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!");
                bounceCartIcon();
                updateCartFloatingCount();
            },
            error: function() {
                showCartToast("‚ùå Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng.", true);
            }
        });
    });

    // ================= UTILITIES =================
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function showCartToast(message, isError = false) {
        const toast = $("#cart-toast");
        toast.text(message);
        toast.css("background", isError ? "#dc3545" : "#198754");
        toast.addClass("show");
        clearTimeout(toast.data("timeout"));
        const timeout = setTimeout(() => toast.removeClass("show"), 2500);
        toast.data("timeout", timeout);
    }

    function bounceCartIcon() {
        const cartBtn = $("#floating-cart .cart-btn");
        cartBtn.addClass("bounce");
        setTimeout(() => cartBtn.removeClass("bounce"), 500);
    }

    function updateCartFloatingCount() {
        $.ajax({
            url: "/alotra-website/api/cart",
            type: "GET",
            headers: { "Authorization": "Bearer " + (localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken")) },
            success: function (cart) {
                $("#cart-count").text(cart.itemsCount || 0);
            }
        });
    }

    // ================= INIT =================
    // ‚úÖ Load categories tr∆∞·ªõc ƒë·ªÉ c√≥ th·ªÉ auto-select t·ª´ URL
    loadCategories().then(() => loadProducts());
});
</script>
</th:block>

</body>
</html>