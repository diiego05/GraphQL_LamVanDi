<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:fragment="layout(pageTitle, pageContent, additionalJs)">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - AloTra Vendor'"></title>

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">
</head>
<body>
<div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-white border-end" id="sidebar-wrapper">
        <div class="sidebar-heading border-bottom text-center py-3">
            <a th:href="@{/vendor/dashboard}" class="text-decoration-none d-flex justify-content-center align-items-center">
                <img th:src="@{/images/logo.jpg}" alt="AloTra Logo" style="height: 50px;">
            </a>
        </div>
        <div class="list-group list-group-flush">
            <a th:href="@{/vendor/dashboard}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'dashboard'} ? 'active-custom' : ''">
                <i class="fas fa-chart-line me-2"></i> T·ªïng quan
            </a>
            <a th:href="@{/vendor/products}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'products'} ? 'active-custom' : ''">
                <i class="fas fa-box me-2"></i> Qu·∫£n l√Ω s·∫£n ph·∫©m
            </a>
            <a th:href="@{/vendor/orders}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'orders'} ? 'active-custom' : ''">
                <i class="fas fa-receipt me-2"></i> Qu·∫£n l√Ω ƒë∆°n h√†ng
            </a>
            <a th:href="@{/vendor/revenue}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'revenue'} ? 'active-custom' : ''">
                <i class="fas fa-sack-dollar me-2"></i> Qu·∫£n l√Ω doanh thu
            </a>
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
            <div class="container-fluid">
                <button class="btn btn-light" id="sidebarToggle"><i class="fas fa-bars"></i></button>

                <div class="d-flex align-items-center ms-auto gap-2">

                    <!-- üè™ N√∫t quay v·ªÅ trang ng∆∞·ªùi d√πng -->
                    <a href="/alotra-website/" class="btn btn-outline-primary">
                        <i class="fas fa-home me-1"></i> Trang mua h√†ng
                    </a>

                    <!-- üîî Th√¥ng b√°o -->
                    <div class="dropdown me-2">
                        <a href="#" class="btn btn-light position-relative" id="vendorNotifDropdown"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell fs-5"></i>
                            <span id="vendorNotifCount"
                                  class="badge bg-danger rounded-pill position-absolute top-0 end-0 translate-middle"
                                  style="display: none;">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="vendorNotifDropdown" style="width: 320px;">
                            <li class="dropdown-header text-center fw-bold text-success">Th√¥ng b√°o</li>
                            <li><hr class="dropdown-divider"></li>
                            <div id="vendorNotifList" class="px-2" style="max-height: 300px; overflow-y: auto;">
                                <p class="text-center text-muted small mb-0">Kh√¥ng c√≥ th√¥ng b√°o</p>
                            </div>
                        </ul>
                    </div>

                    <!-- üë§ Vendor -->
                    <div class="dropdown d-none" id="vendorUserDropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle"
                           id="dropdownVendorUser" data-bs-toggle="dropdown" aria-expanded="false">
                            <img id="vendorAvatar" src="/alotra-website/images/avatar-default.jpg"
                                 alt="Vendor Avatar" width="32" height="32" class="rounded-circle me-2">
                            <div>
                                <div class="fw-bold" id="vendorName">...</div>
                                <div class="small text-muted" id="vendorRole">Vendor</div>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownVendorUser">
                            <li>
                                <a class="dropdown-item" id="logoutBtn" href="#">
                                    <i class="fas fa-sign-out-alt me-2"></i> ƒêƒÉng xu·∫•t
                                </a>
                            </li>
                        </ul>
                    </div>

                    <a th:href="@{/login}" id="loginBtn" class="btn btn-primary d-none">ƒêƒÉng nh·∫≠p</a>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung trang -->
        <div class="container-fluid p-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/vendor/dashboard}">Trang ch·ªß</a></li>
                    <li class="breadcrumb-item" th:if="${parentPageTitle}">
                        <a th:href="@{${parentPageUrl}}" th:text="${parentPageTitle}"></a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page" th:text="${pageTitle}"></li>
                </ol>
            </nav>
            <div class="page-content" th:replace="${pageContent}"></div>
        </div>
    </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Sidebar Toggle -->
<script>
    document.getElementById('sidebarToggle').addEventListener('click', () => {
        document.getElementById('wrapper').classList.toggle('toggled');
    });
</script>

<!-- üîî Th√¥ng b√°o Vendor gi·ªëng header -->
<script type="module">
import { getJwtToken, apiFetch } from '/alotra-website/js/auth-helper.js';

const token = getJwtToken();
const loginBtn = document.getElementById("loginBtn");
const userDropdown = document.getElementById("vendorUserDropdown");
const nameEl = document.getElementById("vendorName");
const avatarEl = document.getElementById("vendorAvatar");

if (!token) {
    loginBtn.classList.remove("d-none");
    userDropdown.classList.add("d-none");
    window.location.href = "/alotra-website/login";
} else {
    const res = await apiFetch("/api/users/me");
    if (res && res.ok) {
        const user = await res.json();
        loginBtn.classList.add("d-none");
        userDropdown.classList.remove("d-none");
        nameEl.textContent = user.fullName;
        if (user.avatarUrl) avatarEl.src = user.avatarUrl;
        loadNotificationsVendor();
        setInterval(loadNotificationsVendor, 30000);
    } else {
        localStorage.removeItem("jwtToken");
        window.location.href = "/alotra-website/login";
    }
}

// üõéÔ∏è Load th√¥ng b√°o Vendor
async function loadNotificationsVendor() {
    const notifCountEl = document.getElementById("vendorNotifCount");
    const notifListEl = document.getElementById("vendorNotifList");

    try {
        const res = await apiFetch(`/api/notifications`);
        if (!res?.ok) throw new Error();
        const data = await res.json();

        const unreadCount = data.filter(n => !n.read).length;
        notifCountEl.textContent = unreadCount || "";
        notifCountEl.style.display = unreadCount > 0 ? "inline-block" : "none";

        if (data.length === 0) {
            notifListEl.innerHTML = `<p class="text-center text-muted small mb-0">Kh√¥ng c√≥ th√¥ng b√°o</p>`;
            return;
        }

        notifListEl.innerHTML = data.map(n => `
            <div class="dropdown-item notif-item d-flex justify-content-between align-items-start ${!n.read ? 'fw-bold' : ''}"
                 data-id="${n.id}" style="cursor:pointer;"
                 title="${new Date(n.createdAt).toLocaleString('vi-VN')}">
                <div class="me-2 flex-grow-1">
                    ${n.title}
                    <div class="small text-muted">${new Date(n.createdAt).toLocaleString('vi-VN')}</div>
                </div>
                ${!n.read ? '<span class="badge rounded-pill bg-primary align-self-center ms-1" style="width:10px;height:10px;">&nbsp;</span>' : ''}
            </div>
        `).join('');

        notifListEl.querySelectorAll(".notif-item").forEach(el => {
            el.addEventListener("click", async () => {
                el.classList.remove('fw-bold');
                const dot = el.querySelector(".badge");
                if (dot) dot.remove();
                const id = el.dataset.id;
                await apiFetch(`/api/notifications/${id}/read`, { method: "PUT" });
                await loadNotificationsVendor();
                showNotificationDetailVendor(id);
            });
        });

    } catch (err) {
        notifListEl.innerHTML = `<p class="text-center text-muted small mb-0">Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p>`;
        console.error(err);
    }
}

// üì© Modal chi ti·∫øt th√¥ng b√°o
async function showNotificationDetailVendor(id) {
    try {
        const res = await apiFetch(`/api/notifications/${id}`);
        if (!res?.ok) throw new Error();
        const notif = await res.json();

        const oldModal = document.getElementById("vendorNotifModal");
        if (oldModal) oldModal.remove();

        const modalHtml = `
        <div class="modal fade" id="vendorNotifModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${notif.title || "Th√¥ng b√°o"}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
              </div>
              <div class="modal-body">
                <p>${notif.message || "Kh√¥ng c√≥ n·ªôi dung chi ti·∫øt."}</p>
                <small class="text-muted">${new Date(notif.createdAt).toLocaleString('vi-VN')}</small>
              </div>
              <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-danger" id="deleteVendorNotifBtn">
                    <i class="fas fa-trash me-1"></i> X√≥a th√¥ng b√°o
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
              </div>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML("beforeend", modalHtml);
        const modal = new bootstrap.Modal(document.getElementById("vendorNotifModal"));
        modal.show();

        document.getElementById("deleteVendorNotifBtn").addEventListener("click", async () => {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o n√†y kh√¥ng?")) {
                await apiFetch(`/api/notifications/${id}`, { method: "DELETE" });
                modal.hide();
                await loadNotificationsVendor();
            }
        });
    } catch {
        alert("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt th√¥ng b√°o!");
    }
}

// üì¥ Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("jwtToken");
    window.location.href = "/alotra-website/login";
});
</script>
<script src="/alotra-website/js/global-modal.js"></script>
<th:block th:if="${additionalJs != null}" th:replace="${additionalJs}"></th:block>
</body>
</html>
