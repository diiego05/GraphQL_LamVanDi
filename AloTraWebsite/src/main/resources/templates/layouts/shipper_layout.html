<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:fragment="layout(pageTitle, pageContent, additionalJs)">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - AloTra Shipper'"></title>

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/admin-style.css}">
</head>
<body>
<div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-white border-end" id="sidebar-wrapper">
        <div class="sidebar-heading border-bottom text-center py-3">
            <a th:href="@{/shipper/dashboard}" class="text-decoration-none d-flex justify-content-center align-items-center">
                <img th:src="@{/images/logo.jpg}" alt="AloTra Logo" style="height: 50px;">
            </a>
        </div>
        <div class="list-group list-group-flush">
            <a th:href="@{/shipper/dashboard}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'dashboard'} ? 'active-custom' : ''">
                <i class="fas fa-chart-line me-2"></i> T·ªïng quan
            </a>

            <a th:href="@{/shipper/deliveries}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'deliveries'} ? 'active-custom' : ''">
                <i class="fas fa-truck me-2"></i> Qu·∫£n l√Ω giao h√†ng
            </a>

            <a th:href="@{/shipper/statistics}" class="list-group-item list-group-item-action"
               th:classappend="${currentPage == 'statistics'} ? 'active-custom' : ''">
                <i class="fas fa-chart-pie me-2"></i> Th·ªëng k√™ giao h√†ng
            </a>
        </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
            <div class="container-fluid">
                <button class="btn btn-light" id="sidebarToggle"><i class="fas fa-bars"></i></button>

                <div class="d-flex align-items-center ms-auto gap-2">

                    <!-- üè™ V·ªÅ trang ch√≠nh -->
                    <a href="/alotra-website/" class="btn btn-outline-primary">
                        <i class="fas fa-home me-1"></i> Trang mua h√†ng
                    </a>

                    <!-- üîî Th√¥ng b√°o -->
                    <div class="dropdown me-2">
                        <a href="#" class="btn btn-light position-relative" id="shipperNotifDropdown"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell fs-5"></i>
                            <span id="shipperNotifCount"
                                  class="badge bg-danger rounded-pill position-absolute top-0 end-0 translate-middle"
                                  style="display: none;">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="shipperNotifDropdown"
                            style="width: 320px;">
                            <li class="dropdown-header text-center fw-bold text-success">Th√¥ng b√°o</li>
                            <li><hr class="dropdown-divider"></li>
                            <div id="shipperNotifList" class="px-2" style="max-height: 300px; overflow-y: auto;">
                                <p class="text-center text-muted small mb-0">Kh√¥ng c√≥ th√¥ng b√°o</p>
                            </div>
                        </ul>
                    </div>

                    <!-- üë§ Shipper -->
                    <div class="dropdown d-none" id="shipperUserDropdown">
                        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle"
                           id="dropdownShipperUser" data-bs-toggle="dropdown" aria-expanded="false">
                            <img id="shipperAvatar" src="/alotra-website/images/avatar-default.jpg"
                                 alt="Shipper Avatar" width="32" height="32" class="rounded-circle me-2">
                            <div>
                                <div class="fw-bold" id="shipperName">...</div>
                                <div class="small text-muted" id="shipperRole">Shipper</div>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownShipperUser">
                            <li>
                                <a class="dropdown-item" id="logoutBtn" href="#">
                                    <i class="fas fa-sign-out-alt me-2"></i> ƒêƒÉng xu·∫•t
                                </a>
                            </li>
                        </ul>
                    </div>

                    <a th:href="@{/login}" id="loginBtn" class="btn btn-primary d-none">ƒêƒÉng nh·∫≠p</a>
                </div>
            </div>
        </nav>

        <!-- N·ªôi dung trang -->
        <div class="container-fluid p-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/shipper/dashboard}">Trang ch·ªß</a></li>
                    <li class="breadcrumb-item" th:if="${parentPageTitle}">
                        <a th:href="@{${parentPageUrl}}" th:text="${parentPageTitle}"></a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page" th:text="${pageTitle}"></li>
                </ol>
            </nav>
            <div class="page-content" th:replace="${pageContent}"></div>
        </div>
    </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Sidebar Toggle -->
<script>
    const sidebarToggle = document.getElementById('sidebarToggle');
    const wrapper = document.getElementById('wrapper');
    sidebarToggle.addEventListener('click', () => wrapper.classList.toggle('toggled'));
</script>

<!-- üîê JWT + Th√¥ng b√°o Shipper -->
<script type="module">
import { getJwtToken, apiFetch } from '/alotra-website/js/auth-helper.js';

const token = getJwtToken();
const loginBtn = document.getElementById("loginBtn");
const userDropdown = document.getElementById("shipperUserDropdown");
const nameEl = document.getElementById("shipperName");
const avatarEl = document.getElementById("shipperAvatar");

if (!token) {
    loginBtn.classList.remove("d-none");
    userDropdown.classList.add("d-none");
    window.location.href = "/alotra-website/login";
} else {
    const res = await apiFetch("/api/users/me");
    if (res && res.ok) {
        const user = await res.json();
        loginBtn.classList.add("d-none");
        userDropdown.classList.remove("d-none");
        nameEl.textContent = user.fullName;
        if (user.avatarUrl) avatarEl.src = user.avatarUrl;
        loadShipperNotifications();
        setInterval(loadShipperNotifications, 30000);
    } else {
        localStorage.removeItem("jwtToken");
        window.location.href = "/alotra-website/login";
    }
}

// üõéÔ∏è Load th√¥ng b√°o
async function loadShipperNotifications() {
    const notifCountEl = document.getElementById("shipperNotifCount");
    const notifListEl = document.getElementById("shipperNotifList");

    try {
        const res = await apiFetch("/api/notifications");
        if (!res || !res.ok) throw new Error();
        const data = await res.json();

        const unreadCount = data.filter(n => !n.isRead).length;
        notifCountEl.textContent = unreadCount > 0 ? unreadCount : "";
        notifCountEl.style.display = unreadCount > 0 ? "flex" : "none";

        if (data.length === 0) {
            notifListEl.innerHTML = `<p class="text-center text-muted small mb-0">Kh√¥ng c√≥ th√¥ng b√°o</p>`;
            return;
        }

        notifListEl.innerHTML = data.map(n => `
            <div class="dropdown-item notif-item ${!n.isRead ? 'fw-bold' : ''}"
                 data-id="${n.id}" style="cursor:pointer;">
                <div>${n.title}</div>
                <small class="text-muted">${new Date(n.createdAt).toLocaleString('vi-VN')}</small>
            </div>
        `).join('');

        notifListEl.querySelectorAll(".notif-item").forEach(el => {
            el.addEventListener("click", async () => {
                el.classList.remove('fw-bold');
                const id = el.dataset.id;
                await apiFetch(`/api/notifications/${id}/read`, { method: "PUT" });
                await loadShipperNotifications();
                showShipperNotificationDetail(id);
            });
        });
    } catch (err) {
        console.error("‚ùå L·ªói khi t·∫£i th√¥ng b√°o shipper:", err);
    }
}

// üì© Modal th√¥ng b√°o
async function showShipperNotificationDetail(id) {
    try {
        const res = await apiFetch(`/api/notifications/${id}`);
        if (!res || !res.ok) throw new Error();
        const notif = await res.json();

        const oldModal = document.getElementById("shipperNotifModal");
        if (oldModal) oldModal.remove();

        const modalHtml = `
        <div class="modal fade" id="shipperNotifModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">${notif.title || "Th√¥ng b√°o"}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>${notif.message || "Kh√¥ng c√≥ n·ªôi dung chi ti·∫øt."}</p>
                <small class="text-muted">${new Date(notif.createdAt).toLocaleString('vi-VN')}</small>
              </div>
              <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-danger" id="deleteShipperNotifBtn">
                    <i class="fas fa-trash me-1"></i> X√≥a th√¥ng b√°o
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
              </div>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML("beforeend", modalHtml);
        const modal = new bootstrap.Modal(document.getElementById("shipperNotifModal"));
        modal.show();

        document.getElementById("deleteShipperNotifBtn").addEventListener("click", async () => {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o n√†y kh√¥ng?")) {
                await apiFetch(`/api/notifications/${id}`, { method: "DELETE" });
                modal.hide();
                await loadShipperNotifications();
            }
        });
    } catch (err) {
        console.error("‚ùå L·ªói khi hi·ªÉn th·ªã chi ti·∫øt th√¥ng b√°o:", err);
    }
}

// üì¥ Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("jwtToken");
    window.location.href = "/alotra-website/login";
});
</script>

<th:block th:if="${additionalJs != null}" th:replace="${additionalJs}"></th:block>
</body>
</html>
