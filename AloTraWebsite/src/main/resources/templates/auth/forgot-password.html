<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/auth_layout :: body(pageTitle='Quên Mật Khẩu', content=~{::content}, additionalJs=~{::additionalJs})}">
<body>

<th:block th:fragment="content">
    <div class="card auth-card">
        <div class="card-body">

            <!-- GIAI ĐOẠN 1: NHẬP EMAIL -->
            <div id="email-form-container">
                <h3 class="card-title text-center mb-4">Quên Mật Khẩu</h3>
                <p class="text-center text-muted small">Nhập email của bạn để nhận mã OTP đặt lại mật khẩu.</p>
                <div id="email-error" class="alert alert-danger d-none"></div>

                <form id="email-form" class="auth-form">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email*</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-auth-primary btn-lg">Gửi mã OTP</button>
                    </div>
                </form>
            </div>

            <!-- GIAI ĐOẠN 2: NHẬP MÃ OTP -->
            <div id="otp-form-container" class="d-none">
                <h3 class="card-title text-center mb-3">Xác thực OTP</h3>
                <p class="text-center text-muted">
                    Mã OTP đã được gửi đến <strong id="otp-email" class="text-dark"></strong>.
                </p>
                <div id="otp-error" class="alert alert-danger d-none"></div>

                <form id="otp-form" class="auth-form">
                    <div class="mb-3">
                        <label for="otp" class="form-label">Mã OTP*</label>
                        <input type="text" class="form-control text-center"
                               id="otp" required maxlength="6" placeholder="_ _ _ _ _ _">
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-auth-primary btn-lg">Xác thực</button>
                    </div>
                </form>
            </div>

            <!-- GIAI ĐOẠN 3: TẠO MẬT KHẨU MỚI -->
            <div id="password-form-container" class="d-none">
                <h3 class="card-title text-center mb-4">Tạo Mật Khẩu Mới</h3>
                <div id="password-error" class="alert alert-danger d-none"></div>

                <form id="password-form" class="auth-form">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Mật khẩu mới*</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" required>
                            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="newPassword">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Xác nhận mật khẩu mới*</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="confirmNewPassword">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-auth-primary btn-lg">Lưu mật khẩu</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</th:block>

<th:block th:fragment="additionalJs">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contextPath = document.body.dataset.contextPath || '';

    // Containers
    const emailContainer = document.getElementById('email-form-container');
    const otpContainer = document.getElementById('otp-form-container');
    const passwordContainer = document.getElementById('password-form-container');

    // Forms
    const emailForm = document.getElementById('email-form');
    const otpForm = document.getElementById('otp-form');
    const passwordForm = document.getElementById('password-form');

    // Inputs
    const emailInput = document.getElementById('email');
    const otpInput = document.getElementById('otp');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmNewPasswordInput = document.getElementById('confirmNewPassword');

    // Errors
    const emailError = document.getElementById('email-error');
    const otpError = document.getElementById('otp-error');
    const passwordError = document.getElementById('password-error');
    const otpEmailDisplay = document.getElementById('otp-email');

    // === Hiện / Ẩn mật khẩu ===
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = document.getElementById(this.getAttribute('data-target'));
            const icon = this.querySelector('i');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        });
    });

    // === Bước 1: Gửi OTP về email ===
    emailForm.addEventListener('submit', async e => {
        e.preventDefault();
        emailError.classList.add('d-none');

        try {
            const response = await fetch(`${contextPath}api/auth/forgot-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: emailInput.value })
            });

            if (response.ok) {
                otpEmailDisplay.textContent = emailInput.value;
                emailContainer.classList.add('d-none');
                otpContainer.classList.remove('d-none');
            } else {
                const text = await response.text();
                emailError.textContent = text || 'Không thể gửi mã OTP. Vui lòng thử lại.';
                emailError.classList.remove('d-none');
            }
        } catch (error) {
            emailError.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
            emailError.classList.remove('d-none');
        }
    });

    // === Bước 2: Xác thực OTP ===
    otpForm.addEventListener('submit', e => {
        e.preventDefault();
        otpError.classList.add('d-none');

        if (otpInput.value.length === 6) {
            otpContainer.classList.add('d-none');
            passwordContainer.classList.remove('d-none');
        } else {
            otpError.textContent = 'Mã OTP phải gồm 6 chữ số.';
            otpError.classList.remove('d-none');
        }
    });

 // === Bước 3: Đặt lại mật khẩu mới ===
    passwordForm.addEventListener('submit', async e => {
        e.preventDefault();
        passwordError.classList.add('d-none');

        if (newPasswordInput.value !== confirmNewPasswordInput.value) {
            passwordError.textContent = 'Mật khẩu xác nhận không khớp.';
            passwordError.classList.remove('d-none');
            return;
        }

        const data = {
            email: emailInput.value,
            otp: otpInput.value,
            newPassword: newPasswordInput.value
        };

        try {
            const response = await fetch(`${contextPath}api/auth/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            // ✅ Đọc JSON phản hồi chính xác
            const resData = await response.json().catch(() => ({}));

            if (response.ok) {
                alert(resData.message || '✅ Đổi mật khẩu thành công! Hãy đăng nhập lại.');
                window.location.href = `${contextPath}login`;
            } else {
                passwordError.textContent = resData.error || '❌ Mã OTP không hợp lệ hoặc đã hết hạn.';
                passwordError.classList.remove('d-none');
            }
        } catch (error) {
            passwordError.textContent = '⚠️ Lỗi kết nối. Vui lòng thử lại.';
            passwordError.classList.remove('d-none');
        }
    });

});
</script>
</th:block>

</body>
</html>
