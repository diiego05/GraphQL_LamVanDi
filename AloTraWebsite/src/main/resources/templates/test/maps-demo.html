<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/default_layout :: layout(
          pageTitle='Google Maps Demo',
          content=~{::content},
          additionalJs=~{::additionalJs}
      )}">
<head>
    <style>
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .result-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            min-height: 60px;
        }
    </style>
</head>
<body>
<th:block th:fragment="content">
    <div class="container my-5">
        <h2 class="mb-4 text-success">
            <i class="fas fa-map-marked-alt me-2"></i>Google Maps API Demo
        </h2>

        <!-- 1. AUTOCOMPLETE -->
        <div class="demo-section">
            <h4 class="mb-3"><i class="fas fa-search me-2"></i>1. T√¨m ki·∫øm ƒë·ªãa ch·ªâ (Autocomplete)</h4>
            <div class="row">
                <div class="col-md-8">
                    <input type="text" id="autocompleteInput" class="form-control"
                           placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ t√¨m ki·∫øm...">
                </div>
                <div class="col-md-4">
                    <button id="btnTestAutocomplete" class="btn btn-success w-100">
                        <i class="fas fa-check me-1"></i> Test Autocomplete
                    </button>
                </div>
            </div>
            <div class="result-box" id="autocompleteResult">
                <small class="text-muted">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</small>
            </div>
        </div>

        <!-- 2. GEOCODING -->
        <div class="demo-section">
            <h4 class="mb-3"><i class="fas fa-map-pin me-2"></i>2. Geocoding (ƒê·ªãa ch·ªâ ‚Üí T·ªça ƒë·ªô)</h4>
            <div class="row">
                <div class="col-md-8">
                    <input type="text" id="geocodeInput" class="form-control"
                           placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·ªÉ geocode..."
                           value="185 Cao Th·∫Øng, Ph∆∞·ªùng 12, Qu·∫≠n 10, TP.HCM">
                </div>
                <div class="col-md-4">
                    <button id="btnGeocode" class="btn btn-primary w-100">
                        <i class="fas fa-location-arrow me-1"></i> Geocode
                    </button>
                </div>
            </div>
            <div class="result-box" id="geocodeResult">
                <small class="text-muted">Nh·∫•n n√∫t ƒë·ªÉ xem t·ªça ƒë·ªô...</small>
            </div>
        </div>

        <!-- 3. DISTANCE CALCULATION -->
        <div class="demo-section">
            <h4 class="mb-3"><i class="fas fa-route me-2"></i>3. T√≠nh kho·∫£ng c√°ch</h4>
            <div class="row mb-2">
                <div class="col-md-6">
                    <label class="form-label">ƒêi·ªÉm A (lat, lng)</label>
                    <input type="text" id="pointA" class="form-control"
                           placeholder="10.762622, 106.660172" value="10.762622, 106.660172">
                </div>
                <div class="col-md-6">
                    <label class="form-label">ƒêi·ªÉm B (lat, lng)</label>
                    <input type="text" id="pointB" class="form-control"
                           placeholder="10.782622, 106.680172" value="10.782622, 106.680172">
                </div>
            </div>
            <button id="btnCalculateDistance" class="btn btn-warning">
                <i class="fas fa-calculator me-1"></i> T√≠nh kho·∫£ng c√°ch
            </button>
            <div class="result-box" id="distanceResult">
                <small class="text-muted">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</small>
            </div>
        </div>

        <!-- 4. MAP DISPLAY -->
        <div class="demo-section">
            <h4 class="mb-3"><i class="fas fa-map me-2"></i>4. Hi·ªÉn th·ªã b·∫£n ƒë·ªì</h4>
            <div class="mb-3">
                <button id="btnShowMap" class="btn btn-info me-2">
                    <i class="fas fa-eye me-1"></i> Hi·ªÉn th·ªã b·∫£n ƒë·ªì
                </button>
                <button id="btnAddMarker" class="btn btn-secondary" disabled>
                    <i class="fas fa-map-marker-alt me-1"></i> Th√™m Marker
                </button>
            </div>
            <div id="map" style="display:none;"></div>
        </div>

        <!-- 5. API STATUS -->
        <div class="demo-section">
            <h4 class="mb-3"><i class="fas fa-info-circle me-2"></i>5. Tr·∫°ng th√°i API</h4>
            <div class="result-box" id="apiStatus">
                <small class="text-muted">ƒêang ki·ªÉm tra...</small>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="additionalJs">
<script>
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üó∫Ô∏è Maps Demo initialized');

    let map = null;
    let markers = [];

    // ========== API STATUS ==========
    async function checkApiStatus() {
        const statusEl = document.getElementById('apiStatus');
        const loaded = await window.googleMapsLoader.load();

        if (loaded) {
            statusEl.innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Google Maps API ƒë√£ s·∫µn s√†ng!</strong>
                    <div class="mt-2 small">
                        <div>‚úÖ API Key: Configured</div>
                        <div>‚úÖ Libraries: places</div>
                        <div>‚úÖ Language: vi</div>
                        <div>‚úÖ Region: VN</div>
                    </div>
                </div>
            `;
        } else {
            statusEl.innerHTML = `
                <div class="text-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    <strong>Google Maps API kh√¥ng kh·∫£ d·ª•ng</strong>
                    <div class="mt-2 small">
                        Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh API key trong application.properties
                    </div>
                </div>
            `;
        }
    }

    // ========== AUTOCOMPLETE ==========
    const autocompleteInput = document.getElementById('autocompleteInput');
    const autocomplete = await window.googleMapsLoader.createAutocomplete(autocompleteInput);

    if (autocomplete) {
        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            const resultEl = document.getElementById('autocompleteResult');

            if (place.geometry) {
                const parsed = window.googleMapsLoader.parseVietnameseAddress(
                    place.address_components || []
                );

                resultEl.innerHTML = `
                    <div class="text-success">
                        <strong>üìç ${place.formatted_address}</strong>
                        <div class="mt-2 small">
                            <div><strong>T·ªça ƒë·ªô:</strong> ${place.geometry.location.lat()}, ${place.geometry.location.lng()}</div>
                            <div><strong>Ph∆∞·ªùng/X√£:</strong> ${parsed.ward || '‚Äî'}</div>
                            <div><strong>Qu·∫≠n/Huy·ªán:</strong> ${parsed.district || '‚Äî'}</div>
                            <div><strong>T·ªânh/TP:</strong> ${parsed.city || '‚Äî'}</div>
                        </div>
                    </div>
                `;
            }
        });
    }

    // ========== GEOCODING ==========
    document.getElementById('btnGeocode').addEventListener('click', async () => {
        const address = document.getElementById('geocodeInput').value;
        const resultEl = document.getElementById('geocodeResult');

        if (!address) {
            resultEl.innerHTML = '<div class="text-warning">‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ</div>';
            return;
        }

        resultEl.innerHTML = '<div class="text-muted">ƒêang geocoding...</div>';

        const result = await window.googleMapsLoader.geocode(address);

        if (result) {
            resultEl.innerHTML = `
                <div class="text-success">
                    <strong>‚úÖ Geocoding th√†nh c√¥ng!</strong>
                    <div class="mt-2">
                        <div><strong>Latitude:</strong> ${result.lat}</div>
                        <div><strong>Longitude:</strong> ${result.lng}</div>
                        <div class="mt-2">
                            <a href="https://www.google.com/maps?q=${result.lat},${result.lng}"
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt me-1"></i> Xem tr√™n Google Maps
                            </a>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultEl.innerHTML = '<div class="text-danger">‚ùå Kh√¥ng th·ªÉ geocode ƒë·ªãa ch·ªâ n√†y</div>';
        }
    });

    // ========== DISTANCE ==========
    document.getElementById('btnCalculateDistance').addEventListener('click', () => {
        const pointAStr = document.getElementById('pointA').value;
        const pointBStr = document.getElementById('pointB').value;
        const resultEl = document.getElementById('distanceResult');

        try {
            const [lat1, lng1] = pointAStr.split(',').map(s => parseFloat(s.trim()));
            const [lat2, lng2] = pointBStr.split(',').map(s => parseFloat(s.trim()));

            if (isNaN(lat1) || isNaN(lng1) || isNaN(lat2) || isNaN(lng2)) {
                throw new Error('Invalid coordinates');
            }

            const distance = window.googleMapsLoader.calculateDistance(lat1, lng1, lat2, lng2);

            resultEl.innerHTML = `
                <div class="text-success">
                    <strong>üìè Kho·∫£ng c√°ch:</strong> ${distance.toFixed(2)} km
                    <div class="mt-2 small text-muted">
                        ƒêi·ªÉm A: (${lat1}, ${lng1})<br>
                        ƒêi·ªÉm B: (${lat2}, ${lng2})
                    </div>
                </div>
            `;
        } catch (e) {
            resultEl.innerHTML = '<div class="text-danger">‚ùå T·ªça ƒë·ªô kh√¥ng h·ª£p l·ªá</div>';
        }
    });

    // ========== MAP ==========
    document.getElementById('btnShowMap').addEventListener('click', async () => {
        const mapEl = document.getElementById('map');
        mapEl.style.display = 'block';

        if (!map) {
            map = await window.googleMapsLoader.createMap(mapEl, {
                center: { lat: 10.762622, lng: 106.660172 },
                zoom: 13
            });

            if (map) {
                document.getElementById('btnAddMarker').disabled = false;
            }
        }
    });

    document.getElementById('btnAddMarker').addEventListener('click', () => {
        if (map) {
            const center = map.getCenter();
            const marker = window.googleMapsLoader.createMarker(map, {
                position: { lat: center.lat(), lng: center.lng() },
                title: `Marker ${markers.length + 1}`,
                animation: google.maps.Animation.DROP
            });
            markers.push(marker);
        }
    });

    // ========== INIT ==========
    await checkApiStatus();
});
</script>
</th:block>
</body>
</html>